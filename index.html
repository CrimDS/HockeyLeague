<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fox & Hounds Hockey League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Black background */
        }
        .card {
            background-color: #111111; /* Near-black card */
            border: 1px solid #333333; /* Dark gray border */
            transition: all 0.2s ease-in-out;
        }
        .card:hover:not(.no-hover) {
            border-color: #FFD700; /* Gold */
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.15); /* Gold shadow */
        }
        .header-glow {
            border-bottom: 1px solid #333333;
        }
        .team-logo {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #333333;
        }
        .score {
            font-size: 2.25rem; /* 36px */
            font-weight: 700;
            color: #f0f6fc;
        }
        .vs-circle {
            background-color: #000000; /* Match body background */
            border: 1px solid #333333;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #8b949e;
        }
        .rank-number {
            font-weight: 600;
            color: #DC143C; /* Crimson */
        }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); }
        .admin-btn, .btn-primary, .btn-secondary, .btn-danger {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .admin-btn { background-color: transparent; border: 1px solid #FFD700; color: #FFD700; }
        .admin-btn:hover { background-color: rgba(255, 215, 0, 0.1); }
        .btn-primary { background-color: #DC143C; color: white; border: 1px solid #DC143C; }
        .btn-primary:hover { background-color: #b81030; }
        .btn-secondary { background-color: #333; color: white; border: 1px solid #333; }
        .btn-secondary:hover { background-color: #444; }
        .btn-danger { background-color: #b91c1c; color: white; }
        .btn-danger:hover { background-color: #991b1b; }
        .form-input {
            background-color: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 6px;
            padding: 8px 12px;
            width: 100%;
        }
        .admin-controls { display: none; }
        body.admin-mode .admin-controls { display: flex; }
        
        /* Player Stats Table */
        .stats-table th {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
            transition: color 0.2s;
        }
        .stats-table th:hover { color: #FFD700; }
        .stats-table th::after {
            font-family: monospace;
            opacity: 0.5;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }
        .stats-table th.sort-asc::after { content: '▲'; opacity: 1; color: #DC143C; }
        .stats-table th.sort-desc::after { content: '▼'; opacity: 1; color: #DC143C; }
        .player-headshot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #333;
        }

        /* Page Navigation */
        .nav-link {
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            position: relative;
            transition: color 0.2s;
            color: #a0a0a0;
        }
        .nav-link.active {
            color: #FFFFFF;
            background-color: #222;
        }
        .nav-link:not(.active):hover {
            color: #FFFFFF;
        }
    </style>
</head>
<body class="text-gray-300">

    <!-- All Modals (Login, Matchup, Team, Confirmation) go here... -->
    <!-- ... (modal HTML is unchanged, so it's omitted for brevity) ... -->
    <div id="admin-login-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">...</div>
    <div id="edit-matchup-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">...</div>
    <div id="team-manager-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">...</div>
    <div id="edit-team-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">...</div>
    <div id="confirmation-modal" class="fixed inset-0 z-50 items-center justify-center hidden modal-backdrop">...</div>

    <div class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="bg-black/70 backdrop-blur-sm sticky top-0 z-10 header-glow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <svg class="h-8 w-8 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">...</svg>
                        <h1 class="text-2xl font-bold text-white">Fox & Hounds Hockey League</h1>
                    </div>
                     <!-- Page Navigation -->
                    <nav class="flex items-center space-x-2">
                        <a href="#league" class="nav-link active" data-page="league">League</a>
                        <a href="#player-stats" class="nav-link" data-page="player-stats">Player Stats</a>
                    </nav>
                    <div>
                         <button id="admin-login-btn" onclick="toggleLoginModal(true)" class="admin-btn">Admin Login</button>
                         <button id="admin-logout-btn" onclick="logout()" class="admin-btn hidden">Logout</button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <!-- League Page -->
            <div id="page-league">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="flex justify-between items-center px-2">
                            <h2 class="text-2xl font-semibold text-white">Weekly Matchups</h2>
                            <div class="admin-controls"><button onclick="addMatchup()" class="admin-btn text-sm">+ Add Matchup</button></div>
                        </div>
                        <div id="matchups-container" class="space-y-6"></div>
                    </div>
                    <div class="space-y-6">
                         <div class="flex justify-between items-center px-2">
                            <h2 class="text-2xl font-semibold text-white">League Standings</h2>
                            <div class="admin-controls"><button onclick="toggleTeamManagerModal(true)" class="admin-btn text-sm">Manage Teams</button></div>
                        </div>
                        <div class="card rounded-lg p-4"><ul id="standings-container" class="divide-y divide-gray-800"></ul></div>
                    </div>
                </div>
            </div>
            
            <!-- Player Stats Page -->
            <div id="page-player-stats" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">NHL Player Stats</h2>
                     <!-- **NEW**: Season Selector and Search Bar -->
                    <div class="flex items-center space-x-4 w-full max-w-lg">
                        <input type="text" id="stats-search" placeholder="Search by player name..." class="form-input flex-grow">
                        <div>
                            <label for="season-select" class="text-sm text-gray-400 mr-2 whitespace-nowrap">Season:</label>
                            <select id="season-select" class="form-input bg-gray-900 border-gray-700"></select>
                        </div>
                    </div>
                </div>
                <div id="player-stats-container" class="card rounded-lg overflow-hidden">
                    <!-- Stats table will be rendered here -->
                </div>
            </div>
        </main>
    </div>

<script>
    // --- DATA STORE ---
    let leagueData = {};
    let isAdmin = false;
    let allPlayerStats = [];
    let sortColumn = { key: 'points', order: 'desc' };

    // --- INITIALIZATION & ROUTING ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        checkAdminState();
        setupNavigation();
        
        // Setup admin forms
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        // ... (other form listeners are unchanged)

        // Setup Player Stats page components
        document.getElementById('stats-search').addEventListener('input', () => renderPlayerStatsTable(allPlayerStats));
        
        // **NEW**: Setup season selector
        const seasonSelect = document.getElementById('season-select');
        populateSeasonSelector();
        seasonSelect.addEventListener('change', () => {
            fetchAndRenderPlayerStats(seasonSelect.value);
        });

        // Initial page load based on URL hash
        handleRouteChange();
    });

    function setupNavigation() {
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = link.getAttribute('href');
            });
        });
        window.addEventListener('hashchange', handleRouteChange);
    }
    
    function handleRouteChange() {
        const hash = window.location.hash || '#league';
        const pageId = `page-${hash.substring(1)}`;
        
        document.querySelectorAll('main > div').forEach(page => page.classList.add('hidden'));
        document.getElementById(pageId)?.classList.remove('hidden');

        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.toggle('active', link.getAttribute('href') === hash);
        });

        // Fetch data if navigating to the player stats page for the first time
        if (pageId === 'page-player-stats' && allPlayerStats.length === 0) {
            fetchAndRenderPlayerStats();
        } else if (pageId === 'page-league') {
             renderAllLeague();
        }
    }

    // --- LEAGUE PAGE FUNCTIONS ---
    // All functions like loadData, saveData, renderMatchups, renderStandings, admin logic, etc.
    // are unchanged and go here. They are omitted for brevity.
    // ...
    function renderAllLeague() { /* renderMatchups(); renderStandings(); */ }
    function loadData() { /* loads from localStorage */ }
    function checkAdminState() { /* checks sessionStorage */ }
    function handleLogin(e) { /* handles admin login */ }
    // ... all other admin/editor functions

    // --- PLAYER STATS PAGE FUNCTIONS ---
    function populateSeasonSelector() {
        const select = document.getElementById('season-select');
        const currentYear = new Date().getFullYear();
        // If it's before October (month 9), the current season hasn't really started for stat purposes.
        // We consider the "current" season to be the one that just concluded.
        const currentSeasonStartYear = new Date().getMonth() < 9 ? currentYear - 1 : currentYear;

        // Populate with the current season and the last 3 seasons (total of 4).
        for (let i = 0; i < 4; i++) {
            const startYear = currentSeasonStartYear - i;
            const seasonId = `${startYear}${startYear + 1}`;
            const option = document.createElement('option');
            option.value = seasonId;
            option.textContent = `${startYear}-${startYear + 1}`;
            
            // Default select the most recent season in the list (the first one).
            if (i === 0) {
                 option.selected = true;
            }
            select.appendChild(option);
        }
    }

    async function fetchAndRenderPlayerStats(seasonId = document.getElementById('season-select').value) {
        const container = document.getElementById('player-stats-container');
        container.innerHTML = `<div class="p-8 text-center text-gray-400">Loading player stats...</div>`;

        try {
            const response = await fetch(`/api/nhl-player-stats?season=${seasonId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            allPlayerStats = await response.json();
            
            if (allPlayerStats.length === 0) {
                 container.innerHTML = `<div class="p-8 text-center text-gray-400">No player stats found for the ${seasonId.slice(0,4)}-${seasonId.slice(4)} season.</div>`;
                 return;
            }

            renderPlayerStatsTable(allPlayerStats);
        } catch (error) {
            console.error('Failed to fetch player stats:', error);
            container.innerHTML = `<div class="p-8 text-center text-red-400">Could not load player stats. Please try again later.</div>`;
        }
    }

    function renderPlayerStatsTable(stats) {
        const container = document.getElementById('player-stats-container');
        const searchTerm = document.getElementById('stats-search').value.toLowerCase();

        const filteredStats = stats.filter(p => p.name.toLowerCase().includes(searchTerm));
        
        // Sort the data
        filteredStats.sort((a, b) => {
            const valA = a[sortColumn.key];
            const valB = b[sortColumn.key];
            const sortOrder = sortColumn.order === 'asc' ? 1 : -1;
            if (valA < valB) return -1 * sortOrder;
            if (valA > valB) return 1 * sortOrder;
            return 0;
        });

        const headers = [
            { key: 'name', label: 'Player' }, { key: 'team', label: 'Team' },
            { key: 'position', label: 'Pos' }, { key: 'gamesPlayed', label: 'GP' },
            { key: 'goals', label: 'G' }, { key: 'assists', label: 'A' },
            { key: 'points', label: 'P' }, { key: 'plusMinus', label: '+/-' },
            { key: 'penaltyMinutes', label: 'PIM' }, { key: 'shotsOnGoal', label: 'SOG' },
            { key: 'hits', label: 'HITS' }, { key: 'powerPlayGoals', label: 'PPG' },
            { key: 'shortHandedGoals', label: 'SHG' }, { key: 'blockedShots', label: 'BS' }
        ];

        const headerHtml = headers.map(h => {
            let sortClass = '';
            if (h.key === sortColumn.key) {
                sortClass = sortColumn.order === 'asc' ? 'sort-asc' : 'sort-desc';
            }
            return `<th data-key="${h.key}" class="p-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider ${sortClass}">${h.label}</th>`;
        }).join('');

        const bodyHtml = filteredStats.map(p => `
            <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                <td class="p-3 whitespace-nowrap">
                    <div class="flex items-center">
                        <img src="${p.headshot}" alt="${p.name}" class="player-headshot" onerror="this.src='https://placehold.co/40x40/333333/FFFFFF?text=${p.name.charAt(0)}'">
                        <div class="ml-3">
                            <div class="text-sm font-medium text-white">${p.name}</div>
                        </div>
                    </div>
                </td>
                <td class="p-3 text-sm text-gray-300">${p.team}</td>
                <td class="p-3 text-sm text-gray-300">${p.position}</td>
                <td class="p-3 text-sm text-gray-300">${p.gamesPlayed}</td>
                <td class="p-3 text-sm text-gray-300">${p.goals}</td>
                <td class="p-3 text-sm text-gray-300">${p.assists}</td>
                <td class="p-3 text-sm text-white font-semibold">${p.points}</td>
                <td class="p-3 text-sm text-gray-300">${p.plusMinus}</td>
                <td class="p-3 text-sm text-gray-300">${p.penaltyMinutes}</td>
                <td class="p-3 text-sm text-gray-300">${p.shotsOnGoal}</td>
                <td class="p-3 text-sm text-gray-300">${p.hits}</td>
                <td class="p-3 text-sm text-gray-300">${p.powerPlayGoals}</td>
                <td class="p-3 text-sm text-gray-300">${p.shortHandedGoals}</td>
                <td class="p-3 text-sm text-gray-300">${p.blockedShots}</td>
            </tr>
        `).join('');

        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-800 stats-table">
                    <thead class="bg-gray-900/50"><tr>${headerHtml}</tr></thead>
                    <tbody class="divide-y divide-gray-800">${bodyHtml}</tbody>
                </table>
            </div>
        `;
        
        // Add sort event listeners
        container.querySelectorAll('th').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.key;
                if (sortColumn.key === key) {
                    sortColumn.order = sortColumn.order === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn.key = key;
                    sortColumn.order = 'desc';
                }
                renderPlayerStatsTable(stats);
            });
        });
    }

</script>
</body>
</html>

