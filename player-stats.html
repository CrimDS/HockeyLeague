<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Stats - Fox & Hounds Hockey League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
        }
        .header-glow {
            border-bottom: 1px solid #333333;
        }
        .nav-link {
            color: #a5a5a5;
            transition: all 0.2s ease-in-out;
            border-bottom: 2px solid transparent;
        }
        .nav-link:hover {
            color: #ffffff;
        }
        .nav-link.active {
            color: #ffffff;
            font-weight: 600;
            border-bottom-color: #DC143C; /* Crimson */
        }
        .tab-link {
            transition: all 0.2s;
        }
        .tab-link.active {
            background-color: #DC143C;
            color: white;
        }
        .table-header-cell {
            cursor: pointer;
            user-select: none;
        }
        .table-header-cell:hover {
            background-color: #222;
        }
        .form-select {
            background-color: #111;
            border: 1px solid #333;
            color: white;
        }
        .loader {
            border: 4px solid #333;
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .pagination-btn {
            background-color: #222;
            border: 1px solid #444;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .pagination-btn:hover:not(:disabled) {
            background-color: #333;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .leader-card {
            background-color: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
        }
        .leader-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 14px;
            border-bottom: 1px solid #222;
        }
        .leader-list-item:last-child {
            border-bottom: none;
        }
        .leader-stat-value {
            font-weight: 600;
            color: #FFD700; /* Gold */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-300">

    <div class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="bg-black/70 backdrop-blur-sm sticky top-0 z-10 header-glow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 9.5a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v2a.5.5 0 01-.5.5h-2a.5.5 0 01-.5-.5v-2zM12 5.5a.5.5 0 00-.5.5v2a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2a.5.5 0 00-.5-.5h-2zM6 12a.5.5 0 00-.5.5v2a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-2a.5.5 0 00-.5-.5H6zM11.5 12a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v2a.5.5 0 01-.5.5h-2a.5.5 0 01-.5-.5v-2z" clip-rule="evenodd" />
                        </svg>
                        <h1 class="text-2xl font-bold text-white">Fox & Hounds Hockey League</h1>
                    </div>
                    <nav class="flex items-center space-x-6">
                        <a href="index.html" class="nav-link py-5">League Home</a>
                        <a href="player-stats.html" class="nav-link active py-5">Player Stats</a>
                    </nav>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6">
                <h2 class="text-3xl font-semibold text-white mb-4 md:mb-0">NHL Player Statistics</h2>
                <div class="flex items-center space-x-4">
                    <select id="season-select" class="form-select rounded-md px-3 py-2 text-sm font-medium">
                        <!-- Seasons will be populated here -->
                    </select>
                    <input id="search-input" type="text" placeholder="Search players..." class="form-select rounded-md px-3 py-2 text-sm w-48">
                </div>
            </div>

            <!-- Stat Leaders Section -->
            <div id="leaderboards-container" class="mb-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Leader cards will be injected here -->
            </div>
            
            <!-- Tabs -->
            <div class="mb-4 border-b border-gray-800">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button id="skaters-tab" class="tab-link active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-md">Skaters</button>
                    <button id="goalies-tab" class="tab-link whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm rounded-t-md text-gray-400 hover:text-white">Goalies</button>
                </nav>
            </div>

            <!-- Stats Table Container -->
            <div id="stats-container" class="overflow-x-auto bg-[#111] border border-gray-800 rounded-lg">
                <div id="loader-container" class="min-h-[600px] flex items-center justify-center">
                    <div class="loader"></div>
                </div>
                <div id="error-container" class="min-h-[600px] hidden items-center justify-center flex-col text-center">
                    <p class="text-lg font-semibold text-red-500">Could not load player stats.</p>
                    <p class="text-gray-400 mt-1">Please try again later.</p>
                </div>

                <!-- Skaters Table -->
                <table id="skaters-table" class="min-w-full divide-y divide-gray-800 hidden">
                    <thead class="bg-gray-900">
                        <tr>
                            <th class="py-3.5 px-4 text-left text-sm font-semibold text-white table-header-cell" data-sort="name">Player</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="team">Team</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="gamesPlayed">GP</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="goals">G</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="assists">A</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="points">P</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="plusMinus">+/-</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="penaltyMinutes">PIM</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="powerPlayGoals">PPG</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="hits">HITS</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="blockedShots">BS</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="timeOnIce">TOI</th>
                        </tr>
                    </thead>
                    <tbody id="skaters-table-body" class="divide-y divide-gray-800">
                        <!-- Skater rows will be injected here -->
                    </tbody>
                </table>
                
                <!-- Goalies Table -->
                <table id="goalies-table" class="min-w-full divide-y divide-gray-800 hidden">
                     <thead class="bg-gray-900">
                        <tr>
                            <th class="py-3.5 px-4 text-left text-sm font-semibold text-white table-header-cell" data-sort="name">Player</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="team">Team</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="gamesPlayed">GP</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="wins">W</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="losses">L</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="otLosses">OTL</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="savePercentage">SV%</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="goalsAgainstAverage">GAA</th>
                            <th class="py-3.5 px-3 text-left text-sm font-semibold text-white table-header-cell" data-sort="shutouts">SO</th>
                        </tr>
                    </thead>
                    <tbody id="goalies-table-body" class="divide-y divide-gray-800">
                        <!-- Goalie rows will be injected here -->
                    </tbody>
                </table>

                 <div id="no-results" class="min-h-[600px] hidden items-center justify-center flex-col text-center">
                    <p class="text-lg font-semibold text-gray-400">No Players Found</p>
                    <p class="text-gray-500 mt-1">There may be no stats available for this season yet, or your search returned no results.</p>
                </div>
            </div>
            
            <!-- Pagination Controls -->
            <div id="pagination-controls" class="hidden justify-between items-center mt-4 px-4 py-2">
                <button id="prev-page-btn" class="pagination-btn">Previous</button>
                <span id="page-info" class="text-sm text-gray-400"></span>
                <button id="next-page-btn" class="pagination-btn">Next</button>
            </div>
        </main>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const seasonSelect = document.getElementById('season-select');
        const searchInput = document.getElementById('search-input');
        const skatersTab = document.getElementById('skaters-tab');
        const goaliesTab = document.getElementById('goalies-tab');
        
        let allSkaters = [];
        let allGoalies = [];
        
        let currentSort = { key: 'points', direction: 'desc' };
        let currentView = 'skaters';
        
        // Pagination state
        let currentPage = 1;
        const rowsPerPage = 50;

        function populateSeasons() {
            const now = new Date();
            let currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            if (currentMonth < 9) { 
                currentYear--;
            }
            
            for (let i = 0; i < 4; i++) {
                const year = currentYear - i;
                const seasonId = `${year}${year + 1}`;
                const seasonLabel = `${year}-${(year + 1).toString().slice(-2)}`;
                const option = document.createElement('option');
                option.value = seasonId;
                option.textContent = seasonLabel;
                seasonSelect.appendChild(option);
            }
        }

        async function fetchData(season) {
            showLoader(true);
            showError(false);
            showTable('skaters', false);
            showTable('goalies', false);
            showNoResults(false);
            showPagination(false);
            document.getElementById('leaderboards-container').innerHTML = '';
            currentPage = 1;

            try {
                const [skatersResponse, goaliesResponse] = await Promise.all([
                    fetch(`/api/nhl-player-stats?season=${season}`),
                    fetch(`/api/nhl-goalie-stats?season=${season}`)
                ]);

                if (!skatersResponse.ok || !goaliesResponse.ok) {
                    throw new Error('Failed to fetch player stats');
                }

                allSkaters = await skatersResponse.json();
                allGoalies = await goaliesResponse.json();
                
                renderLeaderboards(allSkaters);
                renderView();
            } catch (error) {
                console.error('Error fetching stats:', error);
                showError(true);
            } finally {
                showLoader(false);
            }
        }
        
        function renderLeaderboards(skaters) {
            const container = document.getElementById('leaderboards-container');
            container.innerHTML = ''; // Clear previous leaderboards

            const categories = [
                { key: 'goals', title: 'Goal Leaders' },
                { key: 'assists', title: 'Assist Leaders' },
                { key: 'hits', title: 'Hit Leaders' },
                { key: 'blockedShots', title: 'Block Leaders' },
                { key: 'penaltyMinutes', title: 'PIM Leaders' },
                { key: 'plusMinus', title: '+/- Leaders' }
            ];

            categories.forEach(cat => {
                const sortedSkaters = [...skaters].sort((a, b) => {
                    const valA = cat.key === 'penaltyMinutes' ? parseInt(a[cat.key]) : a[cat.key];
                    const valB = cat.key === 'penaltyMinutes' ? parseInt(b[cat.key]) : b[cat.key];
                    return valB - valA;
                });

                const top10 = sortedSkaters.slice(0, 10);

                let listItemsHTML = '';
                top10.forEach(player => {
                    const headshotUrl = `https://assets.nhle.com/mugs/nhl/latest/${player.id}.png`;
                    listItemsHTML += `
                        <li class="leader-list-item">
                            <div class="flex items-center truncate">
                                <img class="h-6 w-6 rounded-full object-cover mr-3 flex-shrink-0" src="${headshotUrl}" onerror="this.src='https://placehold.co/100x100/111111/FFFFFF?text=?';" alt="${player.name}">
                                <span class="truncate">${player.name} <span class="text-xs text-gray-400">${player.team}</span></span>
                            </div>
                            <span class="leader-stat-value ml-2">${player[cat.key]}</span>
                        </li>`;
                });

                const cardHTML = `
                    <div class="leader-card">
                        <h3 class="text-lg font-semibold text-white mb-3">${cat.title}</h3>
                        <ul class="space-y-1">
                            ${listItemsHTML}
                        </ul>
                    </div>`;
                
                container.innerHTML += cardHTML;
            });
        }

        function renderView() {
            if(currentView === 'skaters') {
                showTable('goalies', false);
                renderSkaters();
            } else {
                showTable('skaters', false);
                renderGoalies();
            }
        }

        function getPaginatedData(data) {
             const query = searchInput.value.toLowerCase();
             const filtered = data.filter(p => p.name.toLowerCase().includes(query));

             const sorted = filtered.sort((a, b) => {
                const valA = a[currentSort.key];
                const valB = b[currentSort.key];

                if (currentSort.key === 'timeOnIce') {
                     const timeA = (valA.split(':')[0] * 60) + parseInt(valA.split(':')[1]);
                     const timeB = (valB.split(':')[0] * 60) + parseInt(valB.split(':')[1]);
                     if (currentSort.direction === 'asc') return timeA - timeB;
                     return timeB - timeA;
                }

                if (currentSort.direction === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
             });

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            
            return {
                paginatedItems: sorted.slice(start, end),
                totalItems: sorted.length
            };
        }
        
        function renderSkaters() {
            const { paginatedItems, totalItems } = getPaginatedData(allSkaters);
            const tableBody = document.getElementById('skaters-table-body');
            tableBody.innerHTML = '';
            
            if(totalItems === 0) {
                showNoResults(true);
                showTable('skaters', false);
                showPagination(false);
                return;
            }
            
            paginatedItems.forEach(player => {
                const headshotUrl = `https://assets.nhle.com/mugs/nhl/latest/${player.id}.png`;
                const row = `
                    <tr class="hover:bg-gray-800">
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-white">
                            <div class="flex items-center">
                                <img class="h-8 w-8 rounded-full object-cover" src="${headshotUrl}" onerror="this.src='https://placehold.co/100x100/111111/FFFFFF?text=?';" alt="${player.name}">
                                <div class="ml-3">
                                    <div>${player.name}</div>
                                    <div class="text-xs text-gray-400">${player.position}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.team}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.gamesPlayed}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.goals}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.assists}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-bold text-yellow-400">${player.points}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.plusMinus}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.penaltyMinutes}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.powerPlayGoals}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.hits}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.blockedShots}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.timeOnIce}</td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
            showNoResults(false);
            showTable('skaters', true);
            renderPagination(totalItems);
        }
        
        function renderGoalies() {
            const { paginatedItems, totalItems } = getPaginatedData(allGoalies);
            const tableBody = document.getElementById('goalies-table-body');
            tableBody.innerHTML = '';
            
            if(totalItems === 0) {
                showNoResults(true);
                showTable('goalies', false);
                showPagination(false);
                return;
            }
            
            paginatedItems.forEach(player => {
                const headshotUrl = `https://assets.nhle.com/mugs/nhl/latest/${player.id}.png`;
                const row = `
                    <tr class="hover:bg-gray-800">
                         <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-white">
                            <div class="flex items-center">
                                <img class="h-8 w-8 rounded-full object-cover" src="${headshotUrl}" onerror="this.src='https://placehold.co/100x100/111111/FFFFFF?text=?';" alt="${player.name}">
                                <div class="ml-3">
                                    <div>${player.name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.team}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.gamesPlayed}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.wins}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.losses}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.otLosses}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-bold text-yellow-400">${player.savePercentage.toFixed(3)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.goalsAgainstAverage.toFixed(2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${player.shutouts}</td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
            showNoResults(false);
            showTable('goalies', true);
            renderPagination(totalItems);
        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');

            if (totalPages <= 1) {
                showPagination(false);
                return;
            }

            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            showPagination(true);
        }


        function handleSort(e) {
            const key = e.target.dataset.sort;
            if (!key) return;

            if (currentSort.key === key) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                currentSort.direction = 'desc';
            }
            currentPage = 1;
            renderView();
        }
        
        function handleSearch() {
            currentPage = 1;
            renderView();
        }

        // --- UI State Changers ---
        const showLoader = (show) => document.getElementById('loader-container').style.display = show ? 'flex' : 'none';
        const showError = (show) => document.getElementById('error-container').style.display = show ? 'flex' : 'none';
        const showNoResults = (show) => document.getElementById('no-results').style.display = show ? 'flex' : 'none';
        const showTable = (type, show) => document.getElementById(`${type}-table`).style.display = show ? 'table' : 'none';
        const showPagination = (show) => document.getElementById('pagination-controls').style.display = show ? 'flex' : 'none';


        // --- Event Listeners ---
        seasonSelect.addEventListener('change', (e) => fetchData(e.target.value));
        searchInput.addEventListener('input', handleSearch);
        
        skatersTab.addEventListener('click', () => {
            currentView = 'skaters';
            currentSort = { key: 'points', direction: 'desc' };
            currentPage = 1;
            skatersTab.classList.add('active');
            goaliesTab.classList.remove('active');
            renderView();
        });

        goaliesTab.addEventListener('click', () => {
            currentView = 'goalies';
            currentSort = { key: 'savePercentage', direction: 'desc' };
            currentPage = 1;
            goaliesTab.classList.add('active');
            skatersTab.classList.remove('active');
            renderView();
        });
        
        document.getElementById('skaters-table').querySelector('thead').addEventListener('click', handleSort);
        document.getElementById('goalies-table').querySelector('thead').addEventListener('click', handleSort);
        document.getElementById('prev-page-btn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderView();
            }
        });
        document.getElementById('next-page-btn').addEventListener('click', () => {
             const data = currentView === 'skaters' ? allSkaters : allGoalies;
             const totalPages = Math.ceil(getPaginatedData(data).totalItems / rowsPerPage);
             if (currentPage < totalPages) {
                currentPage++;
                renderView();
             }
        });


        // --- Initial Load ---
        populateSeasons();
        fetchData(seasonSelect.value);
    });
</script>
</body>
</html>

